## 프로젝트 상세설명 1단계 - 다이소 및 편의점 데이터 수집

> 🎯 **목표**: 영등포구 다이소 공식 API 수집 및 카카오 API 기반 편의점 데이터 수집
> 
> 📁 **관련 파일**: 
> - `v2.3.1_collect_yeongdeungpo_daiso.py` (다이소 공식 API + 카카오 API 2중 체크)
> - `v2.3.2_collect_Convenience_Only.py` (편의점만 수집 - 엄격한 영등포구 필터링)
> - `(dh)daiso_endpoint.py` (다이소 공식 API 엔드포인트 발견 - 문제 해결의 핵심)
>
> 🐳 **실행 환경**: Docker (web + db 컨테이너)

---

### 핵심 해결 과제: 다이소 신길점 누락 문제

```
❌ 이전 버전 문제점:
┌─────────────────────────────────────────────────────────────┐
│  카카오 API만 사용 → 검색 결과 45개 제한                     │
│  → 신규 오픈 매장 "다이소 신길점" 누락!                      │
└─────────────────────────────────────────────────────────────┘

✅ 해결 방법:
┌─────────────────────────────────────────────────────────────┐
│  다이소 공식 사이트에서 API 엔드포인트 발견!                 │
│  → (dh)daiso_endpoint.py 로 직접 조회                       │
│  → 16개 매장 전부 수집 (신길점 포함)                        │
└─────────────────────────────────────────────────────────────┘
```

---

### 1-1. Docker 환경 시작

```powershell
# 1. 프로젝트 폴더로 이동
cd C:\A3_radius_collector-Public

# 2. Docker Compose 실행 (백그라운드 모드)
docker compose up -d

# 3. 컨테이너 상태 확인
docker compose ps
```

**예상 결과:**
```
NAME                              IMAGE                    STATUS        PORTS
a3_radius_collector-public-db-1   postgis/postgis:16-3.4   Up           0.0.0.0:5433->5432/tcp
a3_radius_collector-public-web-1  a3_radius_...            Up           0.0.0.0:8000->8000/tcp
```

**컨테이너 구조:**
```
┌─────────────────────────────────────────────────────────────┐
│                    Docker Compose                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐    ┌─────────────────────┐         │
│  │        web          │    │         db          │         │
│  │  (Django + GDAL)    │───▶│  (PostGIS 16-3.4)   │         │
│  │   Port: 8000        │    │   Port: 5433        │         │
│  └─────────────────────┘    └─────────────────────┘         │
│           ↑                                                 │
│     localhost:8000                                          │
└─────────────────────────────────────────────────────────────┘
```

---

### 1-2. Docker에서 연결한 PostgreSQL을 실제 PostgreSQL 서버에서 연결해서 데이터 보기

**PostgreSQL 접속 정보:**
- **호스트**: localhost
- **포트**: 5433 (Docker에서 5432로 매핑)
- **데이터베이스**: radius_collector
- **사용자**: postgres

```powershell
# 1. Docker PostgreSQL 직접 접속
docker compose exec db psql -U postgres -d radius_collector

# 2. 테이블 목록 확인
\dt

# 3. 다이소 테이블 확인
SELECT COUNT(*) FROM yeongdeungpo_daiso;

# 4. 편의점 테이블 확인
SELECT COUNT(*) FROM yeongdeungpo_convenience;

# 5. 종료
\q
```

**외부 DB 클라이언트 (DBeaver, pgAdmin 등) 연결:**
```
Host: localhost
Port: 5433
Database: radius_collector
Username: postgres
Password: (docker-compose.yml에서 확인)
```

---

### 1-3. 마이그레이션 실행

```powershell
# DB 마이그레이션 (최초 1회 또는 모델 변경 시)
docker compose exec web python manage.py migrate

# 마이그레이션 상태 확인
docker compose exec web python manage.py showmigrations
```

---

### 1-4. 다이소 신길점 누락 문제 해결 과정

#### 문제 분석 코드: `(dh)daiso_endpoint.py`

```python
# 다이소 공식 API 엔드포인트 발견!
# 다이소 공식 사이트(daisomall.co.kr)에서 네트워크 분석으로 찾아낸 API

import requests
import json

def get_daiso_stores(keyword):
    url = "https://fapi.daisomall.co.kr/ms/msg/selStr"  # ← 핵심 엔드포인트!
    
    headers = {
        "User-Agent": "Mozilla/5.0...",
        "Content-Type": "application/json",
        "Referer": "https://www.daisomall.co.kr/",
        "Origin": "https://www.daisomall.co.kr"
    }
    
    payload = {
        "curLitd": 126.9088468,     # 영등포구 중심 경도
        "curLttd": 37.4989756,      # 영등포구 중심 위도
        "currentPage": 1,
        "geolocationAgrYn": "Y",
        "keyword": keyword,          # "영등포" 키워드 검색
        "pageSize": 100,             # 충분히 큰 페이지 사이즈
        "srchBassPkupStrYn": "Y",
        "srchYn": "Y"
    }
    
    response = requests.post(url, headers=headers, data=json.dumps(payload))
    # ...
```

**발견 과정:**
1. 다이소 공식 사이트에서 "매장찾기" 기능 접속
2. 브라우저 개발자 도구(F12) → Network 탭 분석
3. POST 요청을 보내는 API 엔드포인트 발견
4. Request/Response 구조 분석하여 Python 코드로 구현

---

### 1-5. 영등포구 다이소 수집 (해결된 코드)

**핵심 개선사항 (v2.3.1):**
```
수집 흐름 (다이소 공식 API + 카카오 API 2중 체크):
┌─────────────────────────────────────────────────────────────┐
│  [1단계] 다이소 공식 API 조회                               │
│  https://fapi.daisomall.co.kr/ms/msg/selStr                │
│  → 영등포 키워드로 16개 매장 조회                           │
└─────────────────────────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────────────────────────┐
│  [2단계] 좌표 검증 및 보완                                   │
│  - 좌표가 (0,0)인 경우 → 카카오 API로 보완                  │
│  - 중복 방지: 다이소 매장코드(strCd) 기준                   │
└─────────────────────────────────────────────────────────────┘
           ↓
       ✅ 16개 매장 전부 저장 (신길점 포함!)
```

**Docker에서 실행:**
```powershell
# 영등포구 다이소 수집 (다이소 공식 API 사용)
docker compose exec web python manage.py v2.3.1_collect_yeongdeungpo_daiso

# 기존 데이터 삭제 후 재수집
docker compose exec web python manage.py v2.3.1_collect_yeongdeungpo_daiso --clear

# 카카오 API 키 직접 지정 (좌표 보완용)
docker compose exec web python manage.py v2.3.1_collect_yeongdeungpo_daiso --api-key=YOUR_KAKAO_API_KEY
```

**예상 결과:**
```
============================================================
📦 다이소 수집 V2 시작 (공식 API + 카카오 보완)
============================================================

🔍 [1단계] 다이소 공식 API 조회...
  → 16개 매장 발견

⚠️ [신도림점] 좌표 누락 (0,0)
  🔧 [2단계] 카카오 API로 좌표 보완 시도...
  ✅ 좌표 보완 성공: (37.5089, 126.8891)

  ✅ [신길점] 생성 | 좌표: (37.5024, 126.9152)
  ✅ [영등포역점] 업데이트 | 좌표: (37.5149, 126.9073)
  ...

============================================================
📊 수집 결과
============================================================
  ✅ 수집 성공: 16개
  🔧 카카오 보완: 2개
  ❌ 실패: 0개

  📊 DB 총 다이소: 16개
```

---

### 1-6. 편의점 데이터 수집 (다이소 기반)

**핵심 로직:**
```python
# v2.3.2_collect_Convenience_Only.py 핵심 코드

# 주변 구 이름 (제외 대상) - 엄격한 필터링
EXCLUDED_GU = ['구로구', '금천구', '양천구', '관악구', '동작구', '서초구', '마포구', '용산구']

def is_strictly_yeongdeungpo(self, address):
    """주소가 정확히 영등포구인지 확인 (엄격한 필터)"""
    if not address:
        return False
    
    # 다른 구 이름이 포함되면 제외
    for gu in EXCLUDED_GU:
        if gu in address:
            return False
    
    # 영등포구가 반드시 포함되어야 함
    return '영등포구' in address
```

**수집 흐름:**
```
┌──────────────────┐
│ YeongdeungpoDaiso │   영등포구 다이소 목록 (16개)
│  (다이소 API)     │
└───────┬──────────┘
        ↓
┌───────────────────────────────────────────┐
│  각 다이소 지점 기준 반경 1.3km 내 검색    │
│  카카오 카테고리: CS2 (편의점)             │
│  사분면 방식으로 검색 (4분할)              │
└───────┬───────────────────────────────────┘
        ↓
  [엄격한 영등포구 필터링]
  - EXCLUDED_GU에 포함된 다른 구 제외
  - '영등포구' 필수 포함
        ↓
┌──────────────────────────┐
│ YeongdeungpoConvenience  │   영등포구 편의점만 저장
│  place_id로 중복 방지     │
└──────────────────────────┘
```

**Docker에서 실행:**
```powershell
# 영등포구 다이소 기준 편의점만 수집
docker compose exec web python manage.py v2.3.2_collect_Convenience_Only

# 기존 데이터 삭제 후 재수집
docker compose exec web python manage.py v2.3.2_collect_Convenience_Only --clear

# 탐색 반경 조정 (기본: 1.3km)
docker compose exec web python manage.py v2.3.2_collect_Convenience_Only --radius=1.5
```

**예상 결과:**
```
총 16개의 영등포구 다이소에 대해 편의점 수집을 시작합니다.
탐색 반경: 1.3km
[1/16] '다이소 신길점' 주변 편의점 탐색 중...
  -> 45개 저장, 12개 스킵 (영등포구 아님)
[2/16] '다이소 영등포역점' 주변 편의점 탐색 중...
  -> 38개 저장, 8개 스킵 (영등포구 아님)
...

--- 수집 완료 ---
  ✅ 이번 수집: 463개
  ⚠️ 스킵 (영등포구 아님): 157개

📊 현재 DB 상태:
  - 영등포구 편의점: 463개
  - 영등포구 외 데이터: 0개
```

---

### 1-7. 1단계 완료 확인

```powershell
# Django Shell에서 전체 확인
docker compose exec web python manage.py shell
```

```python
>>> from stores.models import YeongdeungpoDaiso, YeongdeungpoConvenience

# 1. 영등포구 다이소 수
>>> YeongdeungpoDaiso.objects.count()
# 예상: 16개

# 2. 신길점 확인 (핵심 검증!)
>>> YeongdeungpoDaiso.objects.filter(name__icontains='신길')
# 예상: <QuerySet [<YeongdeungpoDaiso: 다이소 신길점>]>

# 3. 편의점 수
>>> YeongdeungpoConvenience.objects.count()
# 예상: 463개

# 4. 영등포구 외 데이터 확인 (0개여야 함)
>>> wrong = [c for c in YeongdeungpoConvenience.objects.all()[:100] if '영등포구' not in c.address]
>>> len(wrong)
# 예상: 0

>>> exit()
```

---

### 1-8. API 키 설정

> ⚠️ **중요**: API 키 설정이 필요합니다.

**.env 파일 설정:**
```env
# 카카오 API (편의점 수집, 좌표 보완용)
KAKAO_API_KEY=나의_카카오_REST_API_키

# 서울시 OpenAPI (2단계에서 사용)
SEOUL_OPENAPI_KEY=나의_서울시_OPENAPI_키
```

**API 키 발급:**
- 카카오: https://developers.kakao.com/
- 서울시: https://data.seoul.go.kr/

---

### 1-9. Docker 관리 명령어

```powershell
# 로그 확인 (실시간)
docker compose logs -f web

# 컨테이너 중지 (데이터 유지)
docker compose down

# 컨테이너 중지 + 데이터 삭제 (초기화)
docker compose down -v

# 컨테이너 재시작
docker compose restart web

# web 컨테이너만 재빌드
docker compose up -d --build web
```

---

### 1단계 요약

| 작업 | Docker 명령어 | 결과 |
|------|--------------|------|
| 환경 시작 | `docker compose up -d` | web + db 컨테이너 |
| 마이그레이션 | `docker compose exec web python manage.py migrate` | DB 테이블 생성 |
| 다이소 수집 | `docker compose exec web python manage.py v2.3.1_collect_yeongdeungpo_daiso` | 16개 (신길점 포함) |
| 편의점 수집 | `docker compose exec web python manage.py v2.3.2_collect_Convenience_Only` | 463개 |

```
1단계 완료 후 데이터 구조:
┌──────────────────────────┐
│   YeongdeungpoDaiso      │  ← PostgreSQL (PostGIS)
│  영등포구 다이소          │     yeongdeungpo_daiso 테이블
│  (16개, 다이소 공식 API)  │     ✅ 신길점 포함!
└────────┬─────────────────┘
         │ 1:N 관계
         ↓
┌──────────────────────────┐
│ YeongdeungpoConvenience  │
│  영등포구 편의점          │     ✅ 엄격한 영등포구 필터
│  (463개)                 │
└──────────────────────────┘
```

---

> 📌 **다음 단계**: [2단계 - 공공데이터포탈 연동 및 폐업 매장 분석](./프로젝트상세설명(2단계)_공공데이터연동.md)
