## 프로젝트 상세설명 2단계 - 공공데이터포탈 연동 및 폐업 매장 분석

> 🎯 **목표**: 3가지 공공데이터 수집 및 카카오맵 데이터와 비교하여 폐업 매장 탐지
> 
> 📁 **관련 파일**: 
> - `openapi_1.py` (영등포구 휴게음식점 인허가 정보 - 편의점)
> - `openapi_2.py` (영등포구 담배소매업 인허가 정보)
> - `public_data.csv` (소상공인시장진흥공단 상가정보 - CSV)
> - `check_store_closure.py` (폐업 매장 판별 로직)
>
> 🐳 **실행 환경**: Docker (web + db 컨테이너)

---

### 2-1. 공공데이터 개요

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          3가지 공공데이터 소스                            │
├──────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────┐                                     │
│  │ 1. 영등포구 휴게음식점 인허가    │  ← OpenAPI 호출 (openapi_1.py)      │
│  │    (편의점만 필터링)             │     서비스명: LOCALDATA_072405_YD   │
│  └─────────────────────────────────┘                                     │
│  ┌─────────────────────────────────┐                                     │
│  │ 2. 영등포구 담배소매업 인허가    │  ← OpenAPI 호출 (openapi_2.py)      │
│  │    (편의점 필수 인허가)          │     서비스명: LOCALDATA_114302_YD   │
│  └─────────────────────────────────┘                                     │
│  ┌─────────────────────────────────┐                                     │
│  │ 3. 소상공인 상가(상권) 정보      │  ← CSV 파일 분석                    │
│  │    (OpenAPI 없음)               │     public_data.csv                 │
│  └─────────────────────────────────┘                                     │
└──────────────────────────────────────────────────────────────────────────┘
```

---

### 2-2. 영등포구 휴게음식점 인허가 정보 수집 (OpenAPI)

**API 정보:**
- **서비스명**: LOCALDATA_072405_YD
- **데이터 출처**: 서울시 열린데이터광장
- **필터 조건**: 업태명(UPTAENM) = '편의점' AND 영업상태(TRDSTATENM) = '영업/정상'

**핵심 코드 (openapi_1.py):**
```python
# 좌표계 변환: 서울시 OpenAPI는 TM 좌표(EPSG:5174) 사용
from pyproj import Transformer
transformer = Transformer.from_crs("EPSG:5174", "EPSG:4326", always_xy=True)

def convert_tm_to_wgs84(x, y):
    """TM 좌표를 WGS84 위도/경도로 변환"""
    x_float = float(x)
    y_float = float(y)
    lon, lat = transformer.transform(x_float, y_float)
    return lat, lon  # latitude, longitude

# 편의점 + 영업중인 것만 필터링
convenience_stores = [
    row for row in rows 
    if row.get('UPTAENM', '').strip() == '편의점'
    and row.get('TRDSTATENM', '').strip() == '영업/정상'
]
```

**Docker에서 실행:**
```powershell
# Dry run (DB 저장 없이 확인)
docker compose exec web python manage.py openapi_1 --dry-run

# 실제 데이터 저장 (영업중 편의점만)
docker compose exec web python manage.py openapi_1

# 기존 데이터 삭제 후 저장
docker compose exec web python manage.py openapi_1 --clear
```

**예상 결과:**
```
=== 서울시 영등포구 휴게음식점 인허가 정보 수집 시작 ===
총 휴게음식점 데이터: 3,847건
데이터 조회 중... (1 ~ 1000)
  → 영업중 편의점 156건 발견 (누적: 156건)
데이터 조회 중... (1001 ~ 2000)
  → 영업중 편의점 128건 발견 (누적: 284건)
...

총 편의점 데이터: 310개
DB 저장 완료: 신규 310개, 업데이트 0개
=== 수집 완료 ===
```

---

### 2-3. 영등포구 담배소매업 인허가 정보 수집 (OpenAPI)

**API 정보:**
- **서비스명**: LOCALDATA_114302_YD
- **데이터 출처**: 서울시 열린데이터광장
- **특징**: 편의점은 담배 판매를 위해 담배소매업 인허가가 필수

**핵심 코드 (openapi_2.py):**
```python
# 영업중인 것만 필터링 (TRDSTATEGBN이 '01' 또는 TRDSTATENM에 '영업' 포함)
active_stores = [
    row for row in rows 
    if row.get('TRDSTATEGBN', '') == '01' or '영업' in row.get('TRDSTATENM', '')
]
```

**Docker에서 실행:**
```powershell
# Dry run (DB 저장 없이 확인)
docker compose exec web python manage.py openapi_2 --dry-run

# 실제 데이터 저장 (영업중만)
docker compose exec web python manage.py openapi_2

# 전체 데이터 저장 (폐업 포함)
docker compose exec web python manage.py openapi_2 --all

# 기존 데이터 삭제 후 저장
docker compose exec web python manage.py openapi_2 --clear
```

**예상 결과:**
```
=== 서울시 영등포구 담배소매업 인허가 정보 수집 시작 ===
총 담배소매업 데이터: 1,245건
데이터 조회 중... (1 ~ 1000)
  → 영업중 789건 발견 (누적: 789건)
데이터 조회 중... (1001 ~ 1245)
  → 영업중 245건 발견 (누적: 1034건)

총 영업중 담배소매업 데이터: 1,034건
DB 저장 완료: 신규 1034건, 업데이트 0건
=== 수집 완료 ===
```

---

### 2-4. 소상공인 상가(상권) 정보 (CSV 분석)

**데이터 정보:**
- **소스**: 공공데이터포탈 (data.go.kr)
- **데이터셋**: 소상공인시장진흥공단_상가(상권)정보
- **파일명**: `public_data.csv`
- **특징**: OpenAPI 없음 → CSV 파일 직접 다운로드 후 분석

**CSV 컬럼 구조:**
```
┌─────────┬──────────────────┬─────────────────────────┐
│ 컬럼    │ 필드명           │ 예시 값                 │
├─────────┼──────────────────┼─────────────────────────┤
│ Column1 │ 상가업소번호     │ MA0101202208...         │
│ Column2 │ 상호명           │ GS25신길역점            │
│ Column7 │ 상권업종중분류명 │ 종합 소매               │
│ Column9 │ 상권업종소분류명 │ 편의점 ← 필터 조건      │
│ Column15│ 시군구명         │ 영등포구                │
│ Column25│ 지번주소         │ 서울특별시 영등포구...  │
│ Column32│ 도로명주소       │ 서울특별시 영등포구...  │
│ Column38│ 경도             │ 126.917...              │
│ Column39│ 위도             │ 37.498...               │
└─────────┴──────────────────┴─────────────────────────┘
```

**다운로드 방법:**
```
1. https://www.data.go.kr/ 접속
2. 검색: "소상공인시장진흥공단_상가(상권)정보"
3. 서울특별시 > 영등포구 필터 적용
4. CSV 다운로드 → 프로젝트 루트에 'public_data.csv'로 저장
```

---

### 2-5. 폐업 매장 체크 로직 (check_store_closure.py)

**핵심 로직:**
```
┌──────────────────────────────────────────────────────────────────────────┐
│                    폐업 매장 판별 알고리즘 (OR 조건)                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   카카오 API 편의점 (463개) ─┬─ 이름 매칭 ─┐                             │
│                             ├─ 주소 매칭 ─┼─→ 하나라도 매칭 → 정상(영업)  │
│                             └─ 좌표 매칭 ─┘                             │
│                                                                          │
│   비교 대상 (3가지):                                                     │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │ 1. SeoulRestaurantLicense (휴게음식점 인허가 - 편의점)          │    │
│   │ 2. TobaccoRetailLicense (담배소매업 인허가)                     │    │
│   │ 3. public_data.csv (소상공인 상가정보)                          │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│   매칭 우선순위: 이름 > 주소 > 좌표 (OR 조건, 하나만 일치해도 정상)      │
│   아무것도 일치하지 않으면 → 폐업 추정!                                 │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

**핵심 코드:**
```python
# check_store_closure.py

def normalize_name(name):
    """이름 정규화: 공백 제거, 소문자, 특수문자 제거"""
    name = str(name).strip()
    name = name.replace(" ", "").replace("-", "").replace("_", "")
    name = name.lower()
    return name

def extract_road_address(address):
    """도로명 주소에서 핵심 부분 추출"""
    # 서울 표기 통일
    address = address.replace("서울특별시", "서울")
    address = address.replace("서울시", "서울")
    
    # 도로명 + 번호 추출: "~로/길/대로 + 숫자"
    road_pattern = r'([가-힣]+(?:로|길|대로)[0-9가-힣]*)\s*(\d+(?:-\d+)?)'
    match = re.search(road_pattern, address)
    # ...

# 매칭 로직 (OR 조건)
for store in kakao_data:
    is_matched = False
    match_reasons = []
    
    # 1. 이름 매칭
    if store['name_norm'] in all_names:
        is_matched = True
        match_reasons.append("이름")
    
    # 2. 주소 매칭
    if store['address_norm'] in all_addresses:
        is_matched = True
        match_reasons.append("주소")
    
    # 3. 좌표 매칭 (소수점 4자리 반올림)
    coord = (store['lat_round'], store['lng_round'])
    if coord in all_coords:
        is_matched = True
        match_reasons.append("좌표")
    
    # 결과: 하나라도 매칭되면 정상, 아니면 폐업
    status = "정상" if is_matched else "폐업"
```

**Docker에서 실행:**
```powershell
# 폐업 매장 체크 실행 (기본: DB 저장 + CSV 생성)
docker compose exec web python manage.py check_store_closure

# 좌표 비교 정밀도 조정 (기본: 소수점 4자리)
docker compose exec web python manage.py check_store_closure --decimals=3

# 결과 파일명 지정
docker compose exec web python manage.py check_store_closure --output=my_result.csv

# DB 저장 안함 (CSV만 생성)
docker compose exec web python manage.py check_store_closure --no-save-db
```

**실행 결과 예시:**
```
======================================================================
🔍 카카오맵 폐업 매장 체크 프로그램
======================================================================

📥 [1단계] 카카오 API 편의점 데이터 로드 (기준 데이터)...
  ✅ 카카오 API 편의점: 463개

📥 [2단계] 비교 데이터셋 로드...
  ✅ 휴게음식점(편의점): 310개
  ✅ 담배소매점: 1,034개
  ✅ 소상공인상권 CSV: 504개

🔎 [3단계] 매칭 수행 (OR 조건)...
  📊 전체 비교 이름: 4,521개
  📊 전체 비교 주소: 5,234개
  📊 전체 비교 좌표: 4,892개

======================================================================
🎯 매칭 결과
======================================================================
  🔵 정상 영업: 452개
  🔴 폐업 (카카오맵 업데이트 필요): 11개
  📊 전체: 463개

📁 CSV 저장: store_closure_result.csv

💾 [5단계] DB 저장 중...
  ✅ DB 저장 완료: 신규 463개, 업데이트 0개

----------------------------------------------------------------------
🔴 폐업 추정 매장 (11개):
----------------------------------------------------------------------
  [1] CU 영등포타운점
      주소: 서울 영등포구 영등포로 123
  [2] GS25 신길역점
      주소: 서울 영등포구 도림로 456
  ... 외 9개

======================================================================
✅ 완료
======================================================================
```

---

### 2-6. DB에 저장되는 결과 구조

**StoreClosureResult 모델:**
```python
class StoreClosureResult(models.Model):
    place_id = models.CharField(max_length=50, unique=True)  # 카카오 장소 ID
    name = models.CharField(max_length=200)                   # 매장명
    address = models.CharField(max_length=500)                # 주소
    latitude = models.FloatField(null=True)                   # 위도
    longitude = models.FloatField(null=True)                  # 경도
    location = models.PointField(srid=4326, null=True)        # 좌표 (PostGIS)
    status = models.CharField(max_length=20)                  # 정상/폐업
    match_reason = models.CharField(max_length=100)           # 이름, 주소, 좌표
    checked_at = models.DateTimeField(auto_now=True)          # 체크 시각
```

---

### 2-7. PostgreSQL에서 직접 확인

```powershell
# PostgreSQL 접속
docker compose exec db psql -U postgres -d radius_collector

# 폐업 매장 체크 결과 확인
SELECT status, COUNT(*) FROM store_closure_result GROUP BY status;

# 폐업 추정 매장 목록
SELECT name, address, match_reason 
FROM store_closure_result 
WHERE status = '폐업'
LIMIT 20;

# 휴게음식점 인허가 (편의점) 수
SELECT COUNT(*) FROM seoul_restaurant_license WHERE uptaenm = '편의점';

# 담배소매업 인허가 수
SELECT COUNT(*) FROM tobacco_retail_license;

# 종료
\q
```

---

### 2-8. 2단계 완료 확인

```powershell
# Django Shell에서 확인
docker compose exec web python manage.py shell
```

```python
>>> from stores.models import SeoulRestaurantLicense, TobaccoRetailLicense, StoreClosureResult

# 1. 휴게음식점 (편의점만)
>>> SeoulRestaurantLicense.objects.filter(uptaenm='편의점').count()
# 예상: 310개

# 2. 담배소매업
>>> TobaccoRetailLicense.objects.count()
# 예상: 1,000~1,100개

# 3. 폐업 체크 결과
>>> StoreClosureResult.objects.count()
# 예상: 463개 (카카오 API 편의점 수와 동일)

# 4. 폐업 매장 수
>>> StoreClosureResult.objects.filter(status='폐업').count()
# 예상: 11개

# 5. 정상 매장 수
>>> StoreClosureResult.objects.filter(status='정상').count()
# 예상: 452개

>>> exit()
```

---

### 2단계 요약

| 작업 | Docker 명령어 | 결과 |
|------|--------------|------|
| 휴게음식점 수집 | `docker compose exec web python manage.py openapi_1` | 310개 편의점 |
| 담배소매업 수집 | `docker compose exec web python manage.py openapi_2` | ~1,034개 |
| 폐업 체크 | `docker compose exec web python manage.py check_store_closure` | 폐업 11개 판별 |

```
2단계 완료 후 데이터 구조:
┌─────────────────────────────────────────────────────────────────────────┐
│                        비교 데이터 소스                                  │
├───────────────────────┬────────────────────┬───────────────────────────┤
│ SeoulRestaurantLicense│ TobaccoRetailLicense│ public_data.csv          │
│ (휴게음식점-편의점)    │ (담배소매업)        │ (소상공인 상가정보)        │
│ 310개                │ ~1,034개            │ 504개                  │
└───────────┬───────────┴──────────┬─────────┴─────────────┬─────────────┘
            ↓                     ↓                       ↓
      ┌─────────────────────────────────────────────────────────────┐
      │                      OR 조건 매칭                           │
      │              이름 / 주소 / 좌표 중 하나 일치                 │
      └───────────────────────────────┬─────────────────────────────┘
                                      ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                      StoreClosureResult                                  │
│  - 정상 영업: 452개 (공공데이터에서 확인됨)                             │
│  - 폐업 추정: 11개 (어떤 공공데이터에서도 찾을 수 없음)                  │
└─────────────────────────────────────────────────────────────────────────┘
```

---

> 📌 **다음 단계**: [3단계 - 웹 시각화 및 카카오맵 표시](./프로젝트상세설명(3단계)_웹시각화.md)
