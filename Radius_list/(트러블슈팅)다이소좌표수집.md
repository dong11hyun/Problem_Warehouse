# 영등포구 다이소 수집 - 문제 해결 과정

## 🎯 목표
영등포구 내 **16개 다이소 매장**을 완전히 수집하는 것

---

## 🔴 문제 발생 및 디버깅 로그

### Version 1 (v2-1) - 카카오 API 단독 사용

**코드**: `v2-1_collect_yeongdeungpo_daiso.py`

**접근 방식**:
```python
url = "https://dapi.kakao.com/v2/local/search/keyword.json"
query = "서울 영등포구 다이소"
```

**❌ 실패 로그**:
```
✅ 수집된 다이소: 15개
⚠️ 스킵된 항목: 30개
```

**🔍 원인 분석**:
1. 카카오 키워드 검색 API는 **최대 45개** 결과만 반환 (15개 × 3페이지)
2. "다이소 신길점"이 검색 결과에 **아예 포함되지 않음**
3. API 랭킹 알고리즘에 의해 누락 발생

**💭 생각의 흐름**:
> "검색 결과에 15개만 나오는데, 스킵된 30개에도 신길점이 없다... 
> 이건 필터링 문제가 아니라 API 자체가 반환하지 않는 것 같다."

---

### Version 2 (v2-2) - 그리드 기반 영역 검색

**코드**: `v2-2_collect_yeongdeungpo_daiso.py`

**가설**: "영역을 작게 나누면 45개 제한을 우회할 수 있지 않을까?"

**접근 방식**:
```python
# 영등포구를 4x4 = 16개 그리드로 분할
YEONGDEUNGPO_BOUNDS = {
    'min_lat': 37.490, 'max_lat': 37.545,
    'min_lng': 126.876, 'max_lng': 126.944,
}

# rect 파라미터로 영역 제한 검색
params = {
    "query": "다이소",
    "rect": f"{min_lng},{min_lat},{max_lng},{max_lat}",
}

# 추가로 동별 검색도 시도
dong_list = ['여의도동', '신길동', '당산동', ...]
```

**❌ 여전히 실패**:
- 그리드 검색 + 동별 검색을 모두 해도 "신길점" 누락
- 카카오맵 웹에서는 보이지만 API에서는 반환 안됨

**💭 생각의 흐름**:
> "그리드로 세분화해도 안 된다... 이건 API 인덱싱 문제 같다.
> 카카오맵에서 직접 '다이소 신길점'을 검색하면 나오는데 왜 API에서는 안 나올까?
> → 카카오 검색 API의 구조적 한계인 것 같다. 다른 데이터 소스가 필요하다."

---

### 발상의 전환 - 다이소 공식 API 발견

**코드**: `daiso_endpoint(dh).py`

**💡 핵심 발견**:
동료(dh)가 다이소 홈페이지의 내부 API를 발견!

```python
url = "https://fapi.daisomall.co.kr/ms/msg/selStr"
payload = {
    "keyword": "영등포",
    "pageSize": 100,
}
```

**✅ 결과**:
```
--- '영등포' 검색 결과: 총 16건 ---
[영등포역점] 서울특별시 영등포구 영중로 18
[신길점] 서울특별시 영등포구 가마산로 476  ← 드디어 발견!
...
```

**🔍 새로운 문제 발견**:
```
[롯데슈퍼대림점] 좌표: (0.0, 0.0)  ← 좌표 누락
[GS슈퍼여의도점] 좌표: (0.0, 0.0)  ← 좌표 누락
```

**💭 생각의 흐름**:
> "다이소 API는 16개 모두 반환하지만, 일부 좌표가 (0,0)이다.
> 그렇다면... 다이소 API를 1차 소스로 쓰고, 좌표가 없는 것만 카카오 API로 보완하면 되겠다!"

---

### Version 3 (v2-3) - 2중 체크 시스템 (최종 해결책)

**코드**: `v2-3_collect_yeongdeungpo_daiso.py`

**전략**:
```
┌─────────────────────────────────────┐
│  1단계: 다이소 공식 API             │
│  → 16개 매장 + 주소 + (일부)좌표    │
└────────────────┬────────────────────┘
                 ↓
         좌표가 (0,0)?
           ↙        ↘
         No          Yes
          ↓           ↓
      DB 저장    ┌────────────────────┐
                 │  2단계: 카카오 API  │
                 │  → 좌표 보완        │
                 └─────────┬──────────┘
                           ↓
                       DB 저장
```

**핵심 코드**:
```python
# 1단계: 다이소 API
stores = self.fetch_from_daiso_api("영등포")

for store in stores:
    lat = store.get('strLttd', 0)
    lng = store.get('strLitd', 0)
    
    # 좌표 검증
    if lat == 0 or lng == 0:
        # 2단계: 카카오 API로 보완
        coords = self.fetch_coords_from_kakao(name, address, api_key)
        lat, lng = coords['lat'], coords['lng']
    
    # DB 저장 (다이소 매장코드를 ID로 사용)
    YeongdeungpoDaiso.objects.update_or_create(
        daiso_id=store_code,  # 카카오 ID가 아닌 다이소 매장코드
        defaults={...}
    )
```

**✅ 최종 결과**:
```
🔍 [1단계] 다이소 공식 API 조회...
  → 16개 매장 발견
  ✅ [영등포역점] 생성
  ✅ [신길점] 생성          ← 드디어 포함!
  ...
  
⚠️ [롯데슈퍼대림점] 좌표 누락 (0,0)
  🔧 [2단계] 카카오 API로 좌표 보완 시도...
  ✅ 좌표 보완 성공: (37.5030, 126.8960)

📊 수집 결과
  ✅ 수집 성공: 16개
  🔧 카카오 보완: 2개
  ❌ 실패: 0개
```

---

## 📌 핵심 교훈

| 버전 | 접근 방식 | 결과 | 문제점 |
|------|----------|------|--------|
| v2-1 | 카카오 키워드 검색 | 15/16 | API 45개 제한 + 인덱싱 누락 |
| v2-2 | 그리드 + 동별 검색 | 15/16 | 근본적 해결 불가 |
| v2-3 | 다이소 API + 카카오 보완 | **16/16** | ✅ 완전 해결 |

### 깨달은 점

1. **공식 데이터 소스가 최우선**: 카카오 API보다 다이소 공식 API가 더 완전한 데이터 제공
2. **API 한계 인식**: 카카오 키워드 검색은 "검색 경험"을 위한 것, 완전한 DB 조회가 아님
3. **2중 체크의 가치**: 각 API의 장점을 결합하여 완전성 확보
4. **ID 시스템 주의**: 카카오 Place ID와 다이소 매장코드는 완전히 다른 체계

---

## 📁 관련 파일

| 파일 | 역할 |
|------|------|
| `v2-1_collect_yeongdeungpo_daiso.py` | 카카오 API 단독 (실패) |
| `v2-2_collect_yeongdeungpo_daiso.py` | 그리드 검색 시도 (실패) |
| `v2-3_collect_yeongdeungpo_daiso.py` | 2중 체크 시스템 (성공) |
| `daiso_endpoint(dh).py` | 다이소 API 탐색 스크립트 |
