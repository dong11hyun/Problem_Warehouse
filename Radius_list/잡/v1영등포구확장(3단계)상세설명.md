## 영등포구 확장 프로젝트 - 3단계 상세설명

> 🎯 **목표**: 웹 시각화 및 3가지 기능 (제보/새 맵/오류 데이터) 구현
> 
> 📁 **관련 파일**: 
> - `views_closed.py` (뷰 함수들)
> - `urls_closed.py` (URL 라우팅)
> - `templates/stores/*.html` (템플릿 파일들)
>
> 🐳 **실행 환경**: Docker (web + db 컨테이너)

---

### 3-1. Docker 서버 시작

```powershell
# 1. 프로젝트 폴더로 이동
cd C:\A3_radius_collector-Public

# 2. Docker Compose 실행
docker compose up -d

# 3. 컨테이너 상태 확인
docker compose ps

# 4. 로그 실시간 확인 (선택)
docker compose logs -f web
```

**컨테이너 상태 확인:**
```
NAME                              IMAGE                    STATUS        PORTS
a3_radius_collector-public-db-1   postgis/postgis:16-3.4   Up           0.0.0.0:5433->5432/tcp
a3_radius_collector-public-web-1  a3_radius_...            Up           0.0.0.0:8000->8000/tcp
```

**서버 접속:**
```
브라우저에서 http://127.0.0.1:8000/ 접속
```

---

### 3-2. URL 구조

```
http://127.0.0.1:8000/
├── /admin/                     ← Django Admin
├── /map/                       ← 기존 전체 지도
│
└── /stores/                    ← 🆕 영등포구 확장 기능
    ├── /closed/                ← 폐업 의심 매장 목록 (메인)
    ├── /closed/map/            ← 폐업 매장 전용 지도
    ├── /closed/errors/         ← 잘못된 데이터만 보기
    ├── /closed/report/<id>/    ← 매장 제보 페이지
    └── /convenience/           ← 편의점 전용 지도
```

**각 URL 접속 테스트:**
```
브라우저에서 직접 접속:
1. http://127.0.0.1:8000/stores/closed/
2. http://127.0.0.1:8000/stores/closed/map/
3. http://127.0.0.1:8000/stores/closed/errors/
4. http://127.0.0.1:8000/stores/convenience/
```

---

### 3-3. 각 페이지 설명

#### 📋 폐업 의심 매장 목록 (`/stores/closed/`)

```
┌──────────────────────────────────────────────────────────────┐
│  🏪 폐업 의심 매장 관리                                       │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐                     │
│   │   50    │  │    3    │  │   12    │                     │
│   │  전체   │  │  검증됨 │  │  제보됨 │                     │
│   └─────────┘  └─────────┘  └─────────┘                     │
│                                                              │
│   [🗺️ 새로운 맵 만들기]  [⚠️ 잘못된 데이터만 보기]          │
│                                                              │
│   ┌───────────────────────────────────────────────────────┐  │
│   │ 상호명           │ 주소            │ 기준 다이소│ 액션 │  │
│   ├───────────────────────────────────────────────────────┤  │
│   │ CU 영등포역점    │ 영등포구...     │ 다이소A    │ 제보 │  │
│   │ GS25 당산점      │ 영등포구...     │ 다이소B    │ 제보 │  │
│   └───────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

**기능:**
1. 통계 표시 (전체/검증됨/제보됨)
2. 두 가지 버튼:
   - "새로운 맵 만들기" → `/closed/map/`
   - "잘못된 데이터만 보기" → `/closed/errors/`
3. 매장 목록 테이블
4. 각 매장에 "제보하기" 버튼

---

#### 🗺️ 폐업 매장 전용 지도 (`/stores/closed/map/`)

```
┌──────────────────────────────────────────────────────────────┐
│  [🗺️ 폐업 의심 매장 지도]          [총 50개]  [📋 목록]      │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│     🔴 ← 폐업 의심 매장 마커                                  │
│                                                              │
│         ┌─────────────────│──────────────┐                   │
│         │          카카오맵               │                   │
│         │                 🔴              │                   │
│         │       🔴        │  🔴           │                   │
│         │  🔴             │               │                   │
│         │         🔴      │     🔴        │                   │
│         └─────────────────│──────────────┘                   │
│                    ▲                                         │
│     [범례]         │ 클릭하면 인포윈도우 표시                 │
│     🔴 폐업 의심   │                                         │
│     🟢 검증 완료   │                                         │
└──────────────────────────────────────────────────────────────┘
```

---

#### ⚠️ 잘못된 데이터만 보기 (`/stores/closed/errors/`)

공공데이터와 카카오맵 비교 결과 불일치 데이터 표시.

---

#### 📢 매장 제보 페이지 (`/stores/closed/report/<id>/`)

카카오맵 제보 기능 연동.

---

### 3-4. 템플릿 파일 구조

```
stores/templates/
├── map.html                         ← 기존 전체 지도
└── stores/                          ← 🆕 영등포구 확장 템플릿
    ├── closed_stores_list.html      ← 폐업 의심 목록
    ├── closed_stores_map.html       ← 폐업 매장 지도
    ├── error_data_only.html         ← 잘못된 데이터만
    ├── report_store.html            ← 제보 페이지
    └── convenience_stores_map.html  ← 편의점 지도
```

---

### 3-5. Docker 컨테이너 내부 확인

```powershell
# Django Shell 접속
docker compose exec web python manage.py shell

>>> from stores.models import YeongdeungpoDaiso, YeongdeungpoConvenience

# 다이소 수 확인 (그리드 수집)
>>> YeongdeungpoDaiso.objects.count()
# 예상: 15~25개

# 편의점 수 확인
>>> YeongdeungpoConvenience.objects.count()
# 예상: 400~600개

>>> exit()
```

```powershell
# PostgreSQL 직접 접속
docker compose exec db psql -U postgres -d radius_collector

# 테이블 목록
\dt

# 다이소 데이터 확인
SELECT name, address FROM yeongdeungpo_daiso ORDER BY name;

# 편의점 데이터 확인
SELECT name, address FROM yeongdeungpo_convenience LIMIT 10;

\q
```

---

### 3-6. Docker 관리 명령어

```powershell
# 로그 확인 (실시간)
docker compose logs -f web

# 특정 시간 이후 로그
docker compose logs --since 10m web

# 컨테이너 재시작 (코드 변경 반영)
docker compose restart web

# 컨테이너 중지
docker compose down

# 컨테이너 + 데이터 삭제 (완전 초기화)
docker compose down -v

# 이미지 재빌드 (Dockerfile 변경 시)
docker compose up -d --build
```

---

### 3-7. 3단계 완료 확인

```powershell
# 1. Docker 컨테이너 실행 확인
docker compose ps

# 2. 브라우저에서 접속 테스트
```

| URL | 예상 동작 |
|-----|---------| 
| `http://127.0.0.1:8000/stores/closed/` | 매장 목록 표시, 통계 표시 |
| `http://127.0.0.1:8000/stores/closed/map/` | 카카오맵에 마커 표시 |
| `http://127.0.0.1:8000/stores/closed/errors/` | 경고 카드 목록 표시 |
| `http://127.0.0.1:8000/stores/closed/report/1/` | 제보 폼 표시 |
| `http://127.0.0.1:8000/stores/convenience/` | 편의점 지도 표시 |

---

### 3단계 요약

| 페이지 | URL | 기능 |
|--------|-----|------|
| 폐업 의심 목록 | `/stores/closed/` | 3가지 기능 선택 + 목록 |
| 폐업 매장 지도 | `/stores/closed/map/` | 지도 시각화 |
| 잘못된 데이터 | `/stores/closed/errors/` | 검증 필요 목록 |
| 제보 페이지 | `/stores/closed/report/<id>/` | 카카오맵 제보 연동 |
| 편의점 지도 | `/stores/convenience/` | 편의점 전용 지도 |

```
Docker 아키텍처:
┌─────────────────────────────────────────────────────────────┐
│                    Docker Compose                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐    ┌─────────────────────┐         │
│  │        web          │    │         db          │         │
│  │  Django + GDAL      │───▶│  PostGIS 16-3.4     │         │
│  │  Port: 8000         │    │  Port: 5433         │         │
│  │                     │    │                     │         │
│  │  views_closed.py    │    │  radius_collector   │         │
│  │  templates/         │    │  (PostgreSQL DB)    │         │
│  └─────────────────────┘    └─────────────────────┘         │
│           ↑                                                 │
│     브라우저 접속                                            │
│     http://127.0.0.1:8000                                   │
└─────────────────────────────────────────────────────────────┘
```

---

> 📌 **프로젝트 완료!** 
> 
> **사전 설정**: `.env` 파일에 API 키 설정
> ```
> KAKAO_API_KEY=나의_API_키
> ```
>
> 전체 실행 순서:
> ```powershell
> # Docker 시작
> docker compose up -d
> 
> # 1단계: 데이터 수집 (개선판)
> docker compose exec web python manage.py collect_yeongdeungpo_daiso  # 그리드 기반 완전 수집
> docker compose exec web python manage.py collect_convenience_only    # 엄격한 영등포구 필터
> docker compose exec web python manage.py deduplicate_stores
> 
> # 2단계: 공공데이터 비교
> docker compose exec web python manage.py load_public_data --csv=public_data.csv       # CSV 인덱스 매핑
> docker compose exec web python manage.py compare_public_data --csv=public_data.csv --dry-run  # 양방향 비교
> 
> # 3단계: 웹 확인
> # 브라우저: http://127.0.0.1:8000/stores/closed/
> ```

---

## 핵심 개선사항 요약

| 항목 | 기존 | 개선 후 |
|------|------|--------|
| 다이소 수집 | 키워드 검색 (45개 제한) | 그리드 기반 완전 수집 |
| 다이소 필터 | '영등포' 키워드 포함 | 엄격한 영등포구 필터 (다른 구 제외) |
| 편의점 필터 | 필터 없음 | 엄격한 영등포구 필터 |
| 공공데이터 | 스킵 (컬럼 매핑 오류) | 인덱스 기반 매핑 (~504개) |
| 비교 기능 | 폐업만 확인 | 양방향 비교 (공공↔카카오) |
