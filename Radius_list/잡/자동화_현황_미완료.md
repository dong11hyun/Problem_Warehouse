# âŒ ìë™í™”ê°€ ì•ˆ ëœ ë¶€ë¶„ (ê°œì„  í•„ìš”)

> í”„ë¡œì íŠ¸ì—ì„œ **ìˆ˜ë™ ì‘ì—…ì´ í•„ìš”í•˜ê±°ë‚˜ ìë™í™”ë˜ì§€ ì•Šì€ ì˜ì—­** ëª©ë¡ì…ë‹ˆë‹¤.

---

## 1. ğŸ”´ ì»¤ë§¨ë“œ ì‹¤í–‰ ìˆœì„œ (ê°€ì¥ í° ë¬¸ì œ)

### í˜„ì¬ ìƒíƒœ
ê° ì»¤ë§¨ë“œë¥¼ **ìˆ˜ë™ìœ¼ë¡œ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰**í•´ì•¼ í•¨:

```bash
# ìˆœì„œ 1: ë‹¤ì´ì†Œ ìˆ˜ì§‘
docker compose exec web python manage.py v2_3_1_collect_yeongdeungpo_daiso

# ìˆœì„œ 2: í¸ì˜ì  ìˆ˜ì§‘ (ë‹¤ì´ì†Œ ìˆ˜ì§‘ ì™„ë£Œ í›„ ê°€ëŠ¥)
docker compose exec web python manage.py v2_3_2_collect_Convenience_Only

# ìˆœì„œ 3: ê³µê³µë°ì´í„° ìˆ˜ì§‘
docker compose exec web python manage.py openapi_1
docker compose exec web python manage.py openapi_2

# ìˆœì„œ 4: íì—… ë¶„ì„ (ìœ„ ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ í›„ ê°€ëŠ¥)
docker compose exec web python manage.py check_store_closure
```

### ë¬¸ì œì 
- **ì˜ì¡´ì„± ê´€ë¦¬ ì—†ìŒ**: ë‹¤ì´ì†Œ ìˆ˜ì§‘ì´ ì•ˆ ë˜ë©´ í¸ì˜ì  ìˆ˜ì§‘ ë¶ˆê°€
- **ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§ ì—†ìŒ**
- **ì‹¤í–‰ ìˆœì„œë¥¼ ì‚¬ëŒì´ ê¸°ì–µí•´ì•¼ í•¨**

### í•´ê²° ë°©ì•ˆ
```python
# ë°©ë²• 1: Master Command ìƒì„±
# stores/management/commands/run_full_pipeline.py
class Command(BaseCommand):
    def handle(self, *args, **options):
        call_command('v2_3_1_collect_yeongdeungpo_daiso')
        call_command('v2_3_2_collect_Convenience_Only')
        call_command('openapi_1')
        call_command('openapi_2')
        call_command('check_store_closure')
```

```python
# ë°©ë²• 2: Airflow DAG
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG('store_pipeline', schedule_interval='0 2 * * *'):
    collect_daiso >> collect_convenience >> [openapi_1, openapi_2] >> check_closure
```

---

## 2. ğŸ”´ ìŠ¤ì¼€ì¤„ë§/ì£¼ê¸°ì  ì‹¤í–‰

### í˜„ì¬ ìƒíƒœ
- **ëª¨ë“  ìˆ˜ì§‘ì€ ìˆ˜ë™ ì‹¤í–‰**
- cron, Celery, Airflow ë“± ìŠ¤ì¼€ì¤„ëŸ¬ ë¯¸ì—°ë™

### ë¬¸ì œì 
- ë°ì´í„° ìµœì‹ ì„± ìœ ì§€ ë¶ˆê°€
- ë§¤ë²ˆ ì‚¬ëŒì´ ì»¤ë§¨ë“œ ì‹¤í–‰í•´ì•¼ í•¨

### í•´ê²° ë°©ì•ˆ
```yaml
# docker-compose.yml í™•ì¥
celery-beat:
  command: celery -A config beat --loglevel=info
  
celery-worker:
  command: celery -A config worker --loglevel=info
```

```python
# tasks.py
from celery import shared_task

@shared_task
def daily_data_collection():
    call_command('run_full_pipeline')
```

---

## 3. ğŸ”´ ì¸ì ‘ êµ¬ ì œì™¸ ëª©ë¡ ìˆ˜ë™ ê´€ë¦¬

### í˜„ì¬ ìƒíƒœ
```python
# v2_3_2_collect_Convenience_Only.py:21
EXCLUDED_GU = ['êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ì–‘ì²œêµ¬', 'ê´€ì•…êµ¬', 'ë™ì‘êµ¬', 'ì„œì´ˆêµ¬', 'ë§ˆí¬êµ¬', 'ìš©ì‚°êµ¬']
```

### ë¬¸ì œì 
- **ìƒˆë¡œìš´ ì§€ì—­ ìˆ˜ì§‘ ì‹œ ìˆ˜ë™ìœ¼ë¡œ ì¸ì ‘ êµ¬ íŒŒì•… í•„ìš”**
- íœ´ë¨¼ ì—ëŸ¬ ê°€ëŠ¥ì„±

### í•´ê²° ë°©ì•ˆ
```python
# í–‰ì •êµ¬ì—­ API + shapely ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš©
from shapely.geometry import Point, shape

def is_in_target_gu(lat, lng, gu_polygon):
    point = Point(lng, lat)
    return gu_polygon.contains(point)
```

---

## 4. ğŸŸ¡ ì—ëŸ¬ í•¸ë“¤ë§ ë° ì•Œë¦¼

### í˜„ì¬ ìƒíƒœ
- API ì‹¤íŒ¨ ì‹œ `stdout`ì— ì—ëŸ¬ ì¶œë ¥ í›„ ê³„ì† ì§„í–‰
- **ì‹¤íŒ¨ ì•Œë¦¼ ì‹œìŠ¤í…œ ì—†ìŒ**

### ë¬¸ì œì 
- ìˆ˜ì§‘ ì‹¤íŒ¨í•´ë„ ì•Œ ìˆ˜ ì—†ìŒ
- ë°ì´í„° ëˆ„ë½ ë°œìƒ ê°€ëŠ¥

### í•´ê²° ë°©ì•ˆ
```python
# ìŠ¬ë™/ì´ë©”ì¼ ì•Œë¦¼ ì¶”ê°€
import requests

def send_slack_alert(message):
    webhook_url = os.environ.get('SLACK_WEBHOOK_URL')
    requests.post(webhook_url, json={'text': message})

# ì—ëŸ¬ ë°œìƒ ì‹œ
except Exception as e:
    send_slack_alert(f"ğŸš¨ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨: {e}")
```

---

## 5. ğŸŸ¡ ë¡œê¹… ì‹œìŠ¤í…œ

### í˜„ì¬ ìƒíƒœ
- `self.stdout.write()` ë¡œ ì½˜ì†” ì¶œë ¥ë§Œ í•¨
- **íŒŒì¼ ë¡œê¹… ì—†ìŒ**
- **ì‹¤í–‰ ì´ë ¥ ì¶”ì  ë¶ˆê°€**

### í•´ê²° ë°©ì•ˆ
```python
# settings.py
LOGGING = {
    'handlers': {
        'file': {
            'class': 'logging.FileHandler',
            'filename': 'logs/collection.log',
        },
    },
}
```

---

## 6. ğŸŸ¡ ë°ì´í„° ë°±ì—…

### í˜„ì¬ ìƒíƒœ
- Docker ë³¼ë¥¨ìœ¼ë¡œ ë°ì´í„° ì˜ì†ì„±ë§Œ ë³´ì¥
- **ì •ê¸° ë°±ì—… ì—†ìŒ**

### í•´ê²° ë°©ì•ˆ
```bash
# ìë™ ë°±ì—… ìŠ¤í¬ë¦½íŠ¸
#!/bin/bash
docker compose exec db pg_dump -U postgres radius_collector > backup_$(date +%Y%m%d).sql
```

---

## 7. ğŸŸ¡ í…ŒìŠ¤íŠ¸ ìë™í™”

### í˜„ì¬ ìƒíƒœ
- `stores/tests.py` íŒŒì¼ ì¡´ì¬í•˜ë‚˜ **í…ŒìŠ¤íŠ¸ ì½”ë“œ ë¯¸ì‘ì„±**
- CI/CD íŒŒì´í”„ë¼ì¸ ì—†ìŒ

### í•´ê²° ë°©ì•ˆ
```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: pip install -r requirements.txt
      - run: pytest
```

---

## 8. ğŸŸ¡ í™˜ê²½ ë³€ìˆ˜ ê²€ì¦

### í˜„ì¬ ìƒíƒœ
- API í‚¤ê°€ ì—†ìœ¼ë©´ ì‹¤í–‰ ì¤‘ ì—ëŸ¬ ë°œìƒ
- **ì‚¬ì „ ê²€ì¦ ì—†ìŒ**

### í•´ê²° ë°©ì•ˆ
```python
# config/settings.py
import sys

REQUIRED_ENV_VARS = ['KAKAO_API_KEY', 'SEOUL_OPENAPI_KEY']
missing = [v for v in REQUIRED_ENV_VARS if not os.environ.get(v)]
if missing:
    sys.exit(f"âŒ í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ëˆ„ë½: {missing}")
```

---

## ğŸ“Š ìë™í™” í•„ìš” ìš°ì„ ìˆœìœ„

| ìš°ì„ ìˆœìœ„ | í•­ëª© | ë‚œì´ë„ | íš¨ê³¼ |
|---------|------|--------|------|
| ğŸ”´ 1ìˆœìœ„ | ì»¤ë§¨ë“œ í†µí•© (Master Command) | ì‰¬ì›€ | ë§¤ìš° ë†’ìŒ |
| ğŸ”´ 2ìˆœìœ„ | ìŠ¤ì¼€ì¤„ëŸ¬ ì—°ë™ (Celery/Airflow) | ì¤‘ê°„ | ë§¤ìš° ë†’ìŒ |
| ğŸ”´ 3ìˆœìœ„ | ì¸ì ‘ êµ¬ ìë™ í•„í„°ë§ | ì¤‘ê°„ | ë†’ìŒ |
| ğŸŸ¡ 4ìˆœìœ„ | ì—ëŸ¬ ì•Œë¦¼ ì‹œìŠ¤í…œ | ì‰¬ì›€ | ì¤‘ê°„ |
| ğŸŸ¡ 5ìˆœìœ„ | ë¡œê¹… ì‹œìŠ¤í…œ | ì‰¬ì›€ | ì¤‘ê°„ |
| ğŸŸ¡ 6ìˆœìœ„ | í…ŒìŠ¤íŠ¸ ìë™í™” (CI/CD) | ì¤‘ê°„ | ì¤‘ê°„ |
| ğŸŸ¡ 7ìˆœìœ„ | ì •ê¸° ë°±ì—… | ì‰¬ì›€ | ë‚®ìŒ |

---

## ğŸš€ 1ìˆœìœ„ êµ¬í˜„ ì˜ˆì‹œ: Master Command

```python
# stores/management/commands/run_full_pipeline.py
from django.core.management.base import BaseCommand
from django.core.management import call_command

class Command(BaseCommand):
    help = 'ì „ì²´ ë°ì´í„° íŒŒì´í”„ë¼ì¸ì„ ìˆœì°¨ ì‹¤í–‰í•©ë‹ˆë‹¤'

    def handle(self, *args, **options):
        steps = [
            ('v2_3_1_collect_yeongdeungpo_daiso', 'ë‹¤ì´ì†Œ ìˆ˜ì§‘'),
            ('v2_3_2_collect_Convenience_Only', 'í¸ì˜ì  ìˆ˜ì§‘'),
            ('openapi_1', 'íœ´ê²ŒìŒì‹ì  ì¸í—ˆê°€'),
            ('openapi_2', 'ë‹´ë°°ì†Œë§¤ì—… ì¸í—ˆê°€'),
            ('check_store_closure', 'íì—… ë¶„ì„'),
        ]
        
        for command, name in steps:
            self.stdout.write(f"â–¶ {name} ì‹œì‘...")
            try:
                call_command(command)
                self.stdout.write(self.style.SUCCESS(f"âœ… {name} ì™„ë£Œ"))
            except Exception as e:
                self.stdout.write(self.style.ERROR(f"âŒ {name} ì‹¤íŒ¨: {e}"))
                return
        
        self.stdout.write(self.style.SUCCESS("ğŸ‰ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!"))
```

**ì‹¤í–‰:**
```bash
docker compose exec web python manage.py run_full_pipeline
```
