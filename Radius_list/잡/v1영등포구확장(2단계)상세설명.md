## 영등포구 확장 프로젝트 - 2단계 상세설명

> 🎯 **목표**: 공공데이터포탈 데이터 로드 및 카카오맵 데이터 비교
> 
> 📁 **관련 파일**: 
> - `load_public_data.py` (공공데이터 CSV 로드 - 인덱스 기반 매핑)
> - `compare_public_data.py` (공공데이터-카카오 양방향 비교)
>
> 🐳 **실행 환경**: Docker (web + db 컨테이너)

---

### 2-1. 공공데이터포탈에서 데이터 다운로드 (수동 작업)

```
📥 다운로드 순서:
1. https://www.data.go.kr/ 접속
2. 검색: "소상공인시장진흥공단_상가(상권)정보"
3. 서울특별시 > 영등포구 데이터 다운로드 (CSV)
4. 프로젝트 폴더에 저장 (예: public_data.csv)
```

**공공데이터 CSV 구조:**
```
CSV 컬럼 매핑 (Column1, Column2... 형식):
┌─────────┬──────────────────┬─────────────────────┐
│ 컬럼    │ 필드명           │ 예시 값             │
├─────────┼──────────────────┼─────────────────────┤
│ Column1 │ 상가업소번호     │ MA010120220804...   │
│ Column2 │ 상호명           │ GS25신길역점        │
│ Column7 │ 상권업종중분류명 │ 종합 소매           │
│ Column9 │ 상권업종소분류명 │ 편의점 ← 여기 확인! │
│ Column15│ 시군구명         │ 영등포구            │
│ Column25│ 지번주소         │ 서울특별시 영등포구...│
│ Column32│ 도로명주소       │ 서울특별시 영등포구...│
└─────────┴──────────────────┴─────────────────────┘
```

> ⚠️ **CSV 컬럼 주의**: 
> - 헤더가 `Column1, Column2...` 형식일 수 있음
> - 코드가 자동으로 인덱스 기반 매핑 사용

---

### 2-2. 공공데이터 CSV 로드

```
로드 흐름:
┌────────────────────┐        ┌──────────────────────┐
│  공공데이터 CSV     │   →   │    분석 및 필터링     │
│  (영등포구 상가)    │        │  - 편의점만 (소분류)  │
└────────────────────┘        │  - 영등포구만         │
                              │  - 인덱스 기반 매핑   │
                              └──────────────────────┘
```

**Docker에서 실행:**
```powershell
# CSV 파일 분석
docker compose exec web python manage.py load_public_data --csv=public_data.csv

# 특정 구 필터링 (기본: 영등포구)
docker compose exec web python manage.py load_public_data --csv=public_data.csv --gu=영등포구
```

**예상 결과:**
```
CSV 파일 로드 중: public_data.csv
필터링 대상: 영등포구
감지된 컬럼: 39개
인코딩: cp949
⚠️ 일반 헤더 감지 (Column1, Column2...) - 인덱스 기반 매핑 사용

📊 공공데이터 분석 완료!
  - 편의점 데이터: 504개
  - 폐업 상태: 0개
  - 스킵: 0개
```

---

### 2-3. 공공데이터와 카카오맵 데이터 비교 (양방향)

```
양방향 비교 로직:
┌──────────────────────┐         ┌──────────────────────┐
│   공공데이터 (504개)  │◀────────│   카카오맵 (573개)    │
│                      │         │ (YeongdeungpoConv.)  │
└──────────────────────┘         └──────────────────────┘
         │                                 │
         ↓                                 ↓
  주소+상호명 유사도 매칭 (임계값 0.6)
         │
         ↓
┌──────────────────────────────────────────────────────┐
│               비교 결과                               │
├──────────────────────────────────────────────────────┤
│  ✅ 매칭됨: ~388개 (양쪽에서 확인됨)                 │
│  ⚠️ 공공데이터에만 있음: ~116개 (카카오에 없음)      │
│     → 카카오맵 누락 또는 폐업?                       │
│  ⚠️ 카카오에만 있음: ~185개 (공공데이터에 없음)      │
│     → 신규 개업 또는 공공데이터 미반영               │
└──────────────────────────────────────────────────────┘
```

**Docker에서 실행:**
```powershell
# 양방향 비교 실행 (dry-run: 결과만 출력)
docker compose exec web python manage.py compare_public_data --csv=public_data.csv --dry-run

# 매칭 임계값 조정 (기본값: 0.6)
docker compose exec web python manage.py compare_public_data --csv=public_data.csv --threshold=0.5 --dry-run

# 상세 정보 출력
docker compose exec web python manage.py compare_public_data --csv=public_data.csv --verbose --dry-run
```

**예상 결과:**
```
매칭 임계값: 0.6
⚠️ 일반 헤더 감지 - 인덱스 기반 매핑 사용
공공데이터 편의점: 504개
카카오맵 편의점: 573개

--- 비교 결과 ---
  공공데이터: 504개
  카카오맵: 573개
  매칭됨: 388개
  공공데이터에만 있음: 116개
  카카오맵에만 있음: 185개

⚠️ 공공데이터에만 있는 편의점 116개:
   (카카오맵에서 찾을 수 없거나 폐업했을 수 있음)
   1. GS25 영등포점 | 서울특별시 영등포구...
   2. CU 신길역점 | 서울특별시 영등포구...
   ... 외 106개

⚠️ 카카오맵에만 있는 편의점 185개:
   (공공데이터에 등록되지 않았거나 신규 개업)
   1. 세븐일레븐 당산역점 | 서울 영등포구...
   2. 이마트24 여의도점 | 서울 영등포구...
   ... 외 175개
```

---

### 2-4. 유사도 매칭 알고리즘 설명

```python
# compare_public_data.py의 핵심 로직

def similarity(a, b):
    """두 문자열의 유사도 계산 (0.0 ~ 1.0)"""
    from difflib import SequenceMatcher
    return SequenceMatcher(None, a.lower(), b.lower()).ratio()

# 주소 정규화
"서울특별시 영등포구 당산동6가 121-3"
    ↓ 공백/특수문자 제거
"서울특별시영등포구당산동6가1213"

# 유사도 계산
주소_점수 = max(
    similarity(공공데이터_지번주소, 카카오_주소),
    similarity(공공데이터_도로명, 카카오_주소)
) = 0.85

상호명_점수 = similarity("GS25 당산역점", "GS25 당산역2호점") = 0.9

# 가중 평균 (주소 70%, 상호명 30%)
최종_점수 = 0.85 * 0.7 + 0.9 * 0.3 = 0.865

# 임계값 비교
if 최종_점수 >= 0.6:
    매칭_발견!
```

| 임계값 | 정확도 | 탐지율 | 용도 |
|--------|--------|--------|------|
| 0.8 이상 | 높음 | 낮음 | 정확한 매칭만 원할 때 |
| 0.6 (기본) | 중간 | 중간 | 권장 |
| 0.5 이하 | 낮음 | 높음 | 최대한 많은 매칭 |

---

### 2-5. PostgreSQL에서 직접 확인

```powershell
# PostgreSQL 접속
docker compose exec db psql -U postgres -d radius_collector

# 편의점 수 확인
SELECT COUNT(*) FROM yeongdeungpo_convenience;

# 다이소 수 확인 (그리드 수집)
SELECT COUNT(*) FROM yeongdeungpo_daiso;

# 다이소 목록
SELECT name, address FROM yeongdeungpo_daiso ORDER BY name;

# 종료
\q
```

---

### 2-6. 2단계 완료 확인

```powershell
# 1. 공공데이터 로드 테스트
docker compose exec web python manage.py load_public_data --csv=public_data.csv

# 2. 양방향 비교 실행
docker compose exec web python manage.py compare_public_data --csv=public_data.csv --dry-run
```

---

### 2단계 요약

| 작업 | Docker 명령어 | 결과 |
|------|--------------|------|
| 공공데이터 다운로드 | (수동) data.go.kr | CSV 파일 |
| CSV 분석 | `docker compose exec web python manage.py load_public_data --csv=파일` | ~504개 인식 |
| 양방향 비교 | `docker compose exec web python manage.py compare_public_data --csv=파일` | 매칭 결과 |

```
2단계 완료 후 상태:
┌──────────────────────────┐     ┌────────────────────┐
│ YeongdeungpoConvenience  │     │  공공데이터 CSV     │
│   (PostgreSQL)           │     │  (~504개 편의점)   │
│   카카오맵 수집 (~573개)  │     │  인덱스 기반 매핑  │
└─────────┬────────────────┘     └─────────┬──────────┘
          │                                │
          └──────────┬─────────────────────┘
                     ↓
           ┌─────────────────────┐
           │  양방향 비교 결과    │
           │  - 매칭됨: ~388개   │
           │  - 공공만: ~116개   │
           │  - 카카오만: ~185개 │
           └─────────────────────┘
```

---

> 📌 **다음 단계**: [3단계 - 웹 시각화 및 제보 기능](./영등포구확장(3단계)상세설명.md)
