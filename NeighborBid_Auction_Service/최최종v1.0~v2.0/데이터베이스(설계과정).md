# [Database] ë°ì´í„° ë¬´ê²°ì„±ì„ ìœ„í•œ ê²½ë§¤ ì‹œìŠ¤í…œ DB ì„¤ê³„

> ì´ ë¬¸ì„œëŠ” A1_NeighborBid_Auction í”„ë¡œì íŠ¸ì˜ **ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ì² í•™**ê³¼ **ì—”í‹°í‹°(Entity) ê°„ì˜ ê´€ê³„** , ê·¸ë¦¬ê³  ê¸ˆìœµ ê±°ëž˜ì˜ ë¬´ê²°ì„±ì„ ì§€í‚¤ê¸° ìœ„í•œ **í•„ë“œ ì„¤ê³„ ì˜ì‚¬ê²°ì • ê³¼ì •** ì„ ìƒì„¸ížˆ ê¸°ë¡í•©ë‹ˆë‹¤.

---

## 1. ê°œìš”: ì‹ ë¢°í•  ìˆ˜ ìžˆëŠ” ê±°ëž˜ ìž¥ë¶€ ë§Œë“¤ê¸°

### 1.1 ì„¤ê³„ ì² í•™

ê²½ë§¤ ì‹œìŠ¤í…œì€ ë‹¨ìˆœí•œ ê²Œì‹œíŒê³¼ ë‹¬ë¦¬ **'ìžì‚°(ëˆê³¼ ë¬¼ê±´)'** ì´ ì´ë™í•˜ëŠ” ê¸ˆìœµ ì‹œìŠ¤í…œì˜ ì„±ê²©ì„ ë±ë‹ˆë‹¤. ë”°ë¼ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ë‹¨ê³„ì—ì„œ ê°€ìž¥ ì¤‘ìš”í•˜ê²Œ ê³ ë ¤í•œ ê°€ì¹˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

| ê°€ì¹˜ | ì„¤ëª… | ì ìš© ì˜ˆì‹œ |
|:---:|---|---|
| **ì •í•©ì„± (Consistency)** | ëª¨ë“  ê±°ëž˜ í›„ ë°ì´í„°ê°€ ì¼ê´€ëœ ìƒíƒœ ìœ ì§€ | `transaction.atomic()` ì‚¬ìš© |
| **ë¬´ê²°ì„± (Integrity)** | ìž˜ëª»ëœ ë°ì´í„° ìž…ë ¥ ë°©ì§€ | `PositiveIntegerField`, Foreign Key |
| **ì¶”ì ì„± (Traceability)** | ëª¨ë“  ìžê¸ˆ íë¦„ ì¶”ì  ê°€ëŠ¥ | `Transaction` ëª¨ë¸ (Append-Only) |
| **í™•ìž¥ì„± (Scalability)** | ë°ì´í„° ì¦ê°€ì— ëŒ€ì‘ ê°€ëŠ¥í•œ êµ¬ì¡° | ë°˜ì •ê·œí™”, ì¸ë±ì‹± ì „ëžµ |

### 1.2 ê¸°ìˆ  ìŠ¤íƒ

| í™˜ê²½ | ë°ì´í„°ë² ì´ìŠ¤ | ì´ìœ  |
|---|---|---|
| **ê°œë°œ/í…ŒìŠ¤íŠ¸** | SQLite3 | ì„¤ì • ë¶ˆí•„ìš”, íŒŒì¼ ê¸°ë°˜ìœ¼ë¡œ ê°„íŽ¸ |
| **í”„ë¡œë•ì…˜ (ê³„íš)** | PostgreSQL | ë™ì‹œì„± ì²˜ë¦¬, ê³ ê¸‰ ê¸°ëŠ¥ ì§€ì› |

---

## 2. ERD (Entity Relationship Diagram)

### 2.1 ì „ì²´ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           NeighborBid ERD                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  User   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Auction   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Category    â”‚         â”‚
â”‚  â”‚         â”‚ 1:N     â”‚             â”‚ N:1     â”‚               â”‚         â”‚
â”‚  â”‚         â”‚(seller) â”‚             â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚             â”‚                                   â”‚
â”‚       â”‚              â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚       â”‚ 1:1          â”‚             â”‚ N:1     â”‚    Region     â”‚         â”‚
â”‚       â–¼              â”‚             â”‚         â”‚  (Self-Ref)   â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚             â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”‚ Wallet  â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚  â”‚         â”‚                â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â”‚ 1:N                                      â”‚
â”‚       â”‚                     â–¼                                          â”‚
â”‚       â”‚ 1:N          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚       â–¼              â”‚    Bid      â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚Transaction â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ N:1 (bidder)            â”‚
â”‚  â”‚            â”‚                              â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                         â”‚
â”‚                      â”‚   Comment   â”‚         â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚  â”‚   Review    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚             â”‚                         â”‚  User   â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚        â”‚                                      â–²                        â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                        N:1 (reviewer, seller)                          â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚  â”‚  Notification   â”‚â—„â”€â”€â”€â”€ N:1 (recipient) â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚                 â”‚                          â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                                         â”‚  User   â”‚                    â”‚
â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ê´€ê³„ ìš”ì•½

| ê´€ê³„ | ì„¤ëª… | Cardinality |
|---|---|:---:|
| User â†” Wallet | ì‚¬ìš©ìžë‹¹ ì§€ê°‘ 1ê°œ | 1:1 |
| User â†” Auction | íŒë§¤ìžê°€ ì—¬ëŸ¬ ê²½ë§¤ ë“±ë¡ | 1:N |
| Auction â†” Bid | ê²½ë§¤ë‹¹ ì—¬ëŸ¬ ìž…ì°° | 1:N |
| User â†” Bid | ìž…ì°°ìžê°€ ì—¬ëŸ¬ ìž…ì°° | 1:N |
| Wallet â†” Transaction | ì§€ê°‘ë‹¹ ì—¬ëŸ¬ ê±°ëž˜ë‚´ì—­ | 1:N |
| Auction â†” User (watchers) | ì°œí•˜ê¸° (ë‹¤ëŒ€ë‹¤) | M:N |
| Region (Self-Reference) | ì‹œ > êµ¬ > ë™ ê³„ì¸µ | ìž¬ê·€ |

---

## 3. í•µì‹¬ ì„¤ê³„ í¬ì¸íŠ¸ Deep Dive

### 3.1 Wallet ëª¨ë¸ì˜ ì´ì¤‘ ìž¥ë¶€ ì‹œìŠ¤í…œ

#### 3.1.1 ë¬¸ì œ: ì´ì¤‘ ì§€ì¶œ(Double Spending)ì˜ ìœ„í—˜

ë‹¨ìˆœížˆ `balance` í•„ë“œ í•˜ë‚˜ë§Œ ì‚¬ìš©í•  ê²½ìš° ë°œìƒí•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤:

```
[ì‹œë‚˜ë¦¬ì˜¤] ì‚¬ìš©ìž Aì˜ ì§€ê°‘ì— 10,000ì›ì´ ìžˆëŠ” ìƒí™©

ì‹œê°„    í–‰ë™                              balance    ë¬¸ì œì 
14:00   ê²½ë§¤ Xì— 10,000ì› ìž…ì°°            10,000     OK
14:01   ê²½ë§¤ Yì— 10,000ì› ìž…ì°°            10,000     ðŸ”º ê°™ì€ ëˆìœ¼ë¡œ 2ë²ˆ ìž…ì°°!
15:00   ê²½ë§¤ X ë‚™ì°°                       -10,000    ðŸ”º ìŒìˆ˜ ìž”ì•¡ ë°œìƒ
```

**í•µì‹¬ ë¬¸ì œ:**
- ìž…ì°° ì‹œì ì— balanceë¥¼ ì°¨ê°í•˜ì§€ ì•Šìœ¼ë©´ â†’ **ì´ì¤‘ ì§€ì¶œ** í—ˆìš©
- ìž…ì°° ì‹œì ì— balanceë¥¼ ì°¨ê°í•˜ë©´ â†’ **ìœ ì°° ì‹œ í™˜ë¶ˆ ë¡œì§** ë³µìž¡ + UX ì €í•˜
- ê²°ê³¼ì ìœ¼ë¡œ **"ìž…ì°° ì¤‘ì¸ ëˆ"**ì´ë¼ëŠ” ì œ3ì˜ ìƒíƒœê°€ í•„ìš”

#### 3.1.2 í•´ê²°: balance + locked_balance ì´ì¤‘ ìž¥ë¶€

```python
# wallet/models.py
class Wallet(models.Model):
    user = models.OneToOneField(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
    
    # ê°€ìš© ìž”ì•¡ (ì‹¤ì œë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ê¸ˆì•¡)
    balance = models.DecimalField(max_digits=12, decimal_places=0, default=0)
    
    # ìž ê¸´ ìž”ì•¡ (ìž…ì°° ì¤‘ì´ë¼ ì‚¬ìš© ë¶ˆê°€, í•˜ì§€ë§Œ ë‚´ ëˆ)
    locked_balance = models.DecimalField(max_digits=12, decimal_places=0, default=0)
```

**ê°œì„ ëœ íë¦„:**

| ë‹¨ê³„ | í–‰ë™ | balance | locked | ì´ ìžì‚° | ê²°ê³¼ |
|:---:|---|:---:|:---:|:---:|---|
| 0 | ì´ˆê¸° ìƒíƒœ | 10,000 | 0 | 10,000 | - |
| 1 | ê²½ë§¤ X ìž…ì°° | **0** | **10,000** | 10,000 | ðŸ”¹ ì„±ê³µ, ìž”ì•¡ ìž ê¸ˆ |
| 2 | ê²½ë§¤ Y ìž…ì°° ì‹œë„ | 0 | 10,000 | 10,000 | ðŸ”º **ê°€ìš© ìž”ì•¡ ë¶€ì¡±** |
| 3-A | ê²½ë§¤ X **ë‚™ì°°** | 0 | 0 | 0 | íŒë§¤ìžì—ê²Œ ì†¡ê¸ˆ |
| 3-B | ê²½ë§¤ X **ìœ ì°°** | **10,000** | **0** | 10,000 | ðŸ”¹ ìž”ì•¡ ìžë™ ë³µêµ¬ |

**ì—ìŠ¤í¬ë¡œ(Escrow) íŒ¨í„´ ì ìš©:** ì´ ìžì‚° = `balance + locked_balance`ë¡œ í•­ìƒ ì¼ê´€ì„± ìœ ì§€

---

### 3.2 Auction ëª¨ë¸ì˜ `is_national` í”Œëž˜ê·¸

#### 3.2.1 ë„ìž… ë°°ê²½

| ê²½ë§¤ ìœ í˜• | ì˜ˆì‹œ í’ˆëª© | ìž…ì°° ë¹ˆë„ | ì‹¤ì‹œê°„ í•„ìš”ì„± | ì¸í”„ë¼ ë¹„ìš© |
|:---:|---|:---:|:---:|:---:|
| ì „êµ­ ì‹¤ì‹œê°„ | í•œì •íŒ ì‹ ë°œ, ì¸ê¸° êµ¿ì¦ˆ | ì´ˆë‹¹ 10~100ê±´ | **í•„ìˆ˜** |  (WebSocket + Redis) |
| ë™ë„¤ ê²½ë§¤ | ì¤‘ê³  ê°€ì „, ê°€êµ¬ | í•˜ë£¨ 1~5ê±´ | ë¶ˆí•„ìš” |  (HTTPë§Œ) |

**í•µì‹¬ ì˜ë¬¸:** "ëª¨ë“  ê±°ëž˜ì— ë¹„ì‹¼ ì‹¤ì‹œê°„ ì¸í”„ë¼ ë¹„ìš©ì„ ì§€ë¶ˆí•´ì•¼ í• ê¹Œ?"

#### 3.2.2 êµ¬í˜„

```python
# auctions/models.py
class Auction(models.Model):
    # True â†’ WebSocket + Redis ì—”ì§„ ì‚¬ìš© (ì „êµ­ ì‹¤ì‹œê°„ ê²½ë§¤)
    # False â†’ ë‹¨ìˆœ HTTP + DB íŠ¸ëžœìž­ì…˜ ì‚¬ìš© (ë™ë„¤ ê²½ë§¤)
    is_national = models.BooleanField(default=False, verbose_name="ì „êµ­ ì‹¤ì‹œê°„ ê²½ë§¤")
```

**ì•„í‚¤í…ì²˜ ë¶„ê¸°:**

```
ìž…ì°° ìš”ì²­ â†’ is_national ì²´í¬
              â”‚
              â”œâ”€ True  â†’ WebSocket ë¸Œë¡œë“œìºìŠ¤íŠ¸ + Redis Pub/Sub
              â”‚
              â””â”€ False â†’ ë‹¨ìˆœ DB íŠ¸ëžœìž­ì…˜ (ë™ê¸° ì²˜ë¦¬)
```

**íš¨ê³¼:** í”Œëž˜ê·¸ í•˜ë‚˜ë¡œ ì¸í”„ë¼ ë¹„ìš©ì„ ìµœì í™”í•˜ë©´ì„œ í•„ìš”í•œ ê³³ì—ë§Œ ì‹¤ì‹œê°„ì„± ì œê³µ

---

### 3.3 Transaction ëª¨ë¸ì˜ ë¶ˆë³€ì„± (Immutability)

#### 3.3.1 ì™œ UPDATE/DELETEë¥¼ ê¸ˆì§€í•˜ëŠ”ê°€?

ê¸ˆìœµ ê±°ëž˜ ë‚´ì—­ì€ **ì ˆëŒ€ ìˆ˜ì •ë˜ì–´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤**.

| ë°©ì‹ | í™˜ë¶ˆ ì²˜ë¦¬ ì˜ˆì‹œ | ë¬¸ì œì  |
|:---:|---|---|
| UPDATE | ìƒíƒœë¥¼ 'ì·¨ì†Œ'ë¡œ ë³€ê²½ | ì›ë³¸ ê¸°ë¡ **ë³€ì¡°**, ê°ì‚¬ ì¶”ì  ë¶ˆê°€ |
| DELETE | ê¸°ì¡´ ë ˆì½”ë“œ ì‚­ì œ | ê±°ëž˜ ìžì²´ê°€ **ì¦ë°œ** |
| **INSERT** (ì±„íƒ) | ìƒì‡„ íŠ¸ëžœìž­ì…˜ ìƒì„± | ì›ë³¸ + í™˜ë¶ˆ ë‚´ì—­ **ëª¨ë‘ ë³´ì¡´**  |

#### 3.3.2 êµ¬í˜„

```python
# wallet/models.py
class Transaction(models.Model):
    wallet = models.ForeignKey(Wallet, on_delete=models.CASCADE, related_name='transactions')
    amount = models.DecimalField(max_digits=12, decimal_places=0)
    
    TRANSACTION_TYPES = (
        ('DEPOSIT', 'ì¶©ì „'),
        ('BID_LOCK', 'ìž…ì°° ìž ê¸ˆ'),
        ('BID_REFUND', 'ìž…ì°°ê¸ˆ í™˜ë¶ˆ'),
        ('PAYMENT', 'ë‚™ì°° ê²°ì œ'),
        ('EARNING', 'íŒë§¤ ìˆ˜ìµ'),
    )
    transaction_type = models.CharField(max_length=20, choices=TRANSACTION_TYPES)
    description = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
```

**ì‹¤ì œ ì ìš©:**
- `services.py`ì—ì„œëŠ” ì˜¤ì§ `Transaction.objects.create()` ë©”ì„œë“œë§Œ ì‚¬ìš©
- `wallet/admin.py`ì—ì„œ ì‚­ì œ ê¸ˆì§€ ë° ì½ê¸° ì „ìš© ì„¤ì • ê°€ëŠ¥

**í™˜ë¶ˆ ì˜ˆì‹œ:**
```python
# ìž˜ëª»ëœ ë°©ë²• (ðŸ”º)
transaction.delete()

# ì˜¬ë°”ë¥¸ ë°©ë²• (ðŸ”¹) - ìƒì‡„ íŠ¸ëžœìž­ì…˜ ìƒì„±
Transaction.objects.create(
    wallet=wallet,
    amount=10000,  # ì–‘ìˆ˜ = ëŒë ¤ë°›ìŒ
    transaction_type='BID_REFUND',
    description="ê²½ë§¤(ì•„ì´í°) ìƒìœ„ ìž…ì°° ë°œìƒìœ¼ë¡œ í™˜ë¶ˆ"
)
```

---

### 3.4 ì¡°íšŒ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ë°˜ì •ê·œí™” (`current_price`)

#### 3.4.1 ì •ê·œí™” vs ë°˜ì •ê·œí™” íŠ¸ë ˆì´ë“œì˜¤í”„

| ë°©ì‹ | ì¿¼ë¦¬ | ì„±ëŠ¥ | ë°ì´í„° ì •í•©ì„± |
|:---:|---|:---:|:---:|
| ì •ê·œí™” | `SELECT MAX(amount) FROM bid WHERE auction_id = ?` | O(N)  | í•­ìƒ ì •í™• |
| **ë°˜ì •ê·œí™”** | `SELECT current_price FROM auction WHERE id = ?` | **O(1)**  | ê°±ì‹  ë¡œì§ í•„ìš” |

#### 3.4.2 ë„ìž… ê²°ì • ê·¼ê±°

ê²½ë§¤ ì‹œìŠ¤í…œì˜ íŠ¹ì„±:
- **Read:Write ë¹„ìœ¨ = 100:1 ì´ìƒ** (ëª©ë¡ ì¡°íšŒ >>> ìž…ì°°)
- í˜„ìž¬ê°€ëŠ” **ê°€ìž¥ ë¹ˆë²ˆí•˜ê²Œ ì¡°íšŒ**ë˜ëŠ” ë°ì´í„°
- ë”°ë¼ì„œ **ì½ê¸° ì„±ëŠ¥ ìµœì í™”**ê°€ í•©ë¦¬ì 

#### 3.4.3 êµ¬í˜„

```python
# auctions/models.py
class Auction(models.Model):
    current_price = models.PositiveIntegerField(default=0)  # ë°˜ì •ê·œí™”ëœ í•„ë“œ

# auctions/services.py
def place_bid(auction_id, user, amount):
    with transaction.atomic():
        auction = Auction.objects.select_for_update().get(id=auction_id)
        
        # ... ìž…ì°° ê²€ì¦ ë° ì²˜ë¦¬ ...
        
        # [ì“°ê¸° ì˜¤ë²„í—¤ë“œ] ìž…ì°° ì‹œ ë¶€ëª¨ í…Œì´ë¸”ë„ ê°±ì‹ 
        auction.current_price = amount
        auction.save()
```

**ë°ì´í„° ì •í•©ì„± ë³´ìž¥:**
- `transaction.atomic()`: Bid ìƒì„±ê³¼ current_price ê°±ì‹ ì„ í•˜ë‚˜ì˜ íŠ¸ëžœìž­ì…˜ìœ¼ë¡œ
- `select_for_update()`: ë™ì‹œ ìž…ì°° ì‹œ Race Condition ë°©ì§€

---

### 3.5 Region ëª¨ë¸ì˜ ê³„ì¸µ êµ¬ì¡° (Self-Referencing)

#### 3.5.1 êµ¬ì¡°

```python
# common/models.py
class Region(models.Model):
    parent = models.ForeignKey('self', on_delete=models.CASCADE, 
                               null=True, blank=True, related_name='sub_regions')
    name = models.CharField(max_length=50)
    depth = models.IntegerField(default=1)  # 1=ì‹œ/ë„, 2=ì‹œ/êµ°/êµ¬, 3=ì/ë©´/ë™
```

**ë°ì´í„° ì˜ˆì‹œ:**

```
Region í…Œì´ë¸”
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚   name   â”‚ parent_id â”‚ depth â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1 â”‚ ì„œìš¸     â”‚   NULL    â”‚   1   â”‚
â”‚ 10 â”‚ ê°•ë‚¨êµ¬   â”‚     1     â”‚   2   â”‚
â”‚101 â”‚ ì—­ì‚¼ë™   â”‚    10     â”‚   3   â”‚
â”‚102 â”‚ ì‚¼ì„±ë™   â”‚    10     â”‚   3   â”‚
â”‚ 11 â”‚ ì„œì´ˆêµ¬   â”‚     1     â”‚   2   â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.5.2 í•˜ìœ„ ì§€ì—­ ì¡°íšŒ (ìž¬ê·€)

```python
# auctions/views.py
def get_all_descendants(region):
    """ì§€ì—­ì˜ ëª¨ë“  í•˜ìœ„ ì§€ì—­ì„ ìž¬ê·€ì ìœ¼ë¡œ ì°¾ê¸°"""
    descendants = []
    children = region.sub_regions.all()
    for child in children:
        descendants.append(child)
        descendants.extend(get_all_descendants(child))  # ìž¬ê·€ í˜¸ì¶œ
    return descendants

def auction_list(request):
    region_id = request.GET.get('region')
    if region_id:
        selected_region = Region.objects.get(id=region_id)
        regions_to_check = [selected_region] + get_all_descendants(selected_region)
        
        auctions = auctions.filter(
            Q(region__in=regions_to_check) | Q(is_national=True)
        )
```

#### 3.5.3 í–¥í›„ ìµœì í™” ê³ ë ¤

| ë°©ë²• | ì„¤ëª… | ìž¥ì  | ë‹¨ì  |
|---|---|---|---|
| í˜„ìž¬ (ìž¬ê·€) | Pythonì—ì„œ ìž¬ê·€ í˜¸ì¶œ | êµ¬í˜„ ê°„ë‹¨ | ê¹Šì´ê°€ ê¹Šìœ¼ë©´ ì„±ëŠ¥ ì €í•˜ |
| MPTT | django-mptt ë¼ì´ë¸ŒëŸ¬ë¦¬ | íš¨ìœ¨ì ì¸ íŠ¸ë¦¬ ì¿¼ë¦¬ | ì¶”ê°€ í•„ë“œ í•„ìš” |
| ì¸ì ‘ ë¦¬ìŠ¤íŠ¸ ìºì‹± | Redisì— ë¯¸ë¦¬ ê³„ì‚° | ì´ˆê³ ì† ì¡°íšŒ | ë°ì´í„° ë™ê¸°í™” í•„ìš” |

---

## 4. ëª¨ë¸ ìƒì„¸ ì •ì˜

### 4.1 User (users/models.py)

```python
class User(AbstractUser):
    nickname = models.CharField(max_length=50, blank=True, null=True)
    reputation_score = models.IntegerField(default=0)  # 0~100ì  (ë¦¬ë·° ê¸°ë°˜)
    region = models.ForeignKey(Region, on_delete=models.SET_NULL, null=True)
```

### 4.2 Auction (auctions/models.py)

```python
class Auction(models.Model):
    seller = models.ForeignKey(User, on_delete=models.CASCADE, related_name='my_auctions')
    
    # ìƒí’ˆ ì •ë³´
    title = models.CharField(max_length=100)
    description = models.TextField()
    image = models.ImageField(upload_to='auction_images/', blank=True, null=True)
    
    # ê°€ê²© ì •ë³´ (PositiveIntegerFieldë¡œ ìŒìˆ˜ ë°©ì§€)
    start_price = models.PositiveIntegerField()
    current_price = models.PositiveIntegerField(default=0)  # ë°˜ì •ê·œí™”
    instant_price = models.PositiveIntegerField(blank=True, null=True)
    bid_unit = models.PositiveIntegerField(default=1000)
    
    # ì‹œê°„ ì •ë³´
    start_time = models.DateTimeField()
    end_time = models.DateTimeField()
    
    # ìƒíƒœ
    STATUS_CHOICES = (
        ('WAITING', 'ëŒ€ê¸°ì¤‘'),
        ('ACTIVE', 'ì§„í–‰ì¤‘'),
        ('ENDED', 'ì¢…ë£Œë¨'),
        ('CANCELLED', 'ì·¨ì†Œë¨'),
    )
    status = models.CharField(max_length=10, choices=STATUS_CHOICES, default='WAITING')
    
    # ë¶„ë¥˜
    region = models.ForeignKey(Region, on_delete=models.SET_NULL, null=True)
    category = models.ForeignKey(Category, on_delete=models.SET_NULL, null=True)
    is_national = models.BooleanField(default=False)  # ì „êµ­ ì‹¤ì‹œê°„ ì—¬ë¶€
    
    # ìƒí’ˆ ìƒíƒœ
    CONDITION_CHOICES = [
        ('NEW', 'ìƒˆ ìƒí’ˆ'),
        ('USED_S', 'Sê¸‰ (ë¯¸ì‚¬ìš©)'),
        ('USED_A', 'Aê¸‰ (ì‚¬ìš©ê° ì ìŒ)'),
        ('USED_B', 'Bê¸‰ (ë³´í†µ)'),
        ('USED_C', 'Cê¸‰ (í•˜ìž ìžˆìŒ)'),
    ]
    condition = models.CharField(max_length=10, choices=CONDITION_CHOICES, default='USED_A')
    
    # ë°°ì†¡ë¹„
    SHIPPING_CHOICES = [
        ('SELLER', 'íŒë§¤ìž ë¶€ë‹´'),
        ('BUYER', 'êµ¬ë§¤ìž ë¶€ë‹´'),
    ]
    shipping_payer = models.CharField(max_length=10, choices=SHIPPING_CHOICES, default='BUYER')
    
    # ì°œí•˜ê¸° (M:N)
    watchers = models.ManyToManyField(User, related_name='watchlist', blank=True)
```

---

## 5. ì¸ë±ì‹± ì „ëžµ (í–¥í›„ ê³„íš)

### 5.1 ì˜ˆì • ì¸ë±ìŠ¤

| í…Œì´ë¸” | ì¸ë±ìŠ¤ | ì¿¼ë¦¬ ìµœì í™” ëŒ€ìƒ |
|---|---|---|
| Auction | `(status, end_time)` | ì§„í–‰ ì¤‘ ê²½ë§¤ ì¤‘ ë§ˆê° ìž„ë°• ìˆœ |
| Auction | `(region_id, status)` | ì§€ì—­ë³„ ì§„í–‰ ì¤‘ ê²½ë§¤ |
| Bid | `(auction_id, -amount)` | íŠ¹ì • ê²½ë§¤ì˜ í˜„ìž¬ 1ë“± |
| Transaction | `(wallet_id, created_at)` | ì§€ê°‘ë³„ ê±°ëž˜ ë‚´ì—­ ì¡°íšŒ |

### 5.2 ìƒì„± SQL ì˜ˆì‹œ

```sql
CREATE INDEX idx_active_auction ON auction (status, end_time) WHERE status = 'ACTIVE';
CREATE INDEX idx_bid_ranking ON bid (auction_id, amount DESC);
```

---

## 6. ê²°ë¡ 

ë°ì´í„°ë² ì´ìŠ¤ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ **ë¼ˆëŒ€** ìž…ë‹ˆë‹¤.

í™”ë ¤í•œ ê¸°ëŠ¥ë„ ì¤‘ìš”í•˜ì§€ë§Œ, **"ëˆì€ ì ˆëŒ€ í‹€ë¦¬ë©´ ì•ˆ ëœë‹¤"** ëŠ” ëŒ€ì›ì¹™ ì•„ëž˜ ì„¤ê³„ëœ ì´ ìŠ¤í‚¤ë§ˆëŠ” ì„œë¹„ìŠ¤ì˜ ì‹ ë¢°ì„±ì„ ì§€íƒ±í•˜ëŠ” ê°€ìž¥ ë“ ë“ í•œ ë²„íŒ€ëª©ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.

| ì„¤ê³„ ì›ì¹™ | ì ìš© ë°©ë²• |
|---|---|
| **ì´ì¤‘ ì§€ì¶œ ë°©ì§€** | balance + locked_balance ì´ì¤‘ ìž¥ë¶€ |
| **ê±°ëž˜ ì¶”ì ì„±** | Transaction ëª¨ë¸ (Append-Only) |
| **ì¡°íšŒ ì„±ëŠ¥** | current_price ë°˜ì •ê·œí™” |
| **ì§€ì—­ í™•ìž¥ì„±** | Self-Referencing Region |
| **ìœ ì—°í•œ ì•„í‚¤í…ì²˜** | is_national í”Œëž˜ê·¸ |

> **ìž‘ì„±ìž:** A1_NeighborBid_Auction DB ê°œë°œíŒ€
> **ê´€ë ¨ ë¬¸ì„œ:** [02_CORE_LOGIC_ANALYSIS.md](02_CORE_LOGIC_ANALYSIS.md) | [03_SOFTWARE_PATTERNS.md](03_SOFTWARE_PATTERNS.md)

